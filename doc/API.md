# API λ νΌλ°μ¤ - LGD liteStat

λ””μ¤ν”λ μ΄ μ μ΅° λ°μ΄ν„° λ¶„μ„ μ‹μ¤ν…μ„ μ„ν• μƒμ„Έ API λ¬Έμ„μ…λ‹λ‹¤. λ¨λ“  μ—”λ“ν¬μΈνΈμ— λ€ν• μ„¤λ…κ³Ό curl μμ κ°€ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

## κΈ°λ³Έ URL (Base URL)

```
http://localhost:8080
```

> **μ°Έκ³ **: ν”„λ΅λ•μ… ν™κ²½μ—μ„ ν”„λ΅ νΈμ—”λ“λ” `http://localhost:8081`μ—μ„ μ ‘μ†ν•λ©°, Nginxκ°€ API μ”μ²­μ„ λ°±μ—”λ“(8080)λ΅ ν”„λ΅μ‹ν•©λ‹λ‹¤.

## κ³µμ¥ μ„ νƒ (Facility Selection)

λ¨λ“  λ°μ΄ν„° μ΅°ν λ° λ¶„μ„ APIλ” νΉμ • κ³µμ¥ λ°μ΄ν„°λ² μ΄μ¤(`data/{facility}/duck.db`)λ¥Ό λ€μƒμΌλ΅ ν•κΈ° μ„ν•΄ κ³µμ¥ μ„ νƒμ„ μ§€μ›ν•©λ‹λ‹¤.

- **ν—¤λ” (Header)**: `X-Facility-Code: A1T`
- **μΏΌλ¦¬ νλΌλ―Έν„° (Query Parameter)**: `?facility_code=A1T`
- **κΈ°λ³Έκ°’ (Default)**: μƒλµ μ‹ μ²« λ²μ§Έλ΅ κµ¬μ„±λ κ³µμ¥(μ: `A1T`)μ„ μ‚¬μ©ν•©λ‹λ‹¤.

---

## π“‹ λ©μ°¨

1. [ν—¬μ¤ μ²΄ν¬ (Health Check)](#1-ν—¬μ¤-μ²΄ν¬)
2. [λ°μ΄ν„° μ΅°ν API](#λ°μ΄ν„°-μ΅°ν-apis)
   - [κ²€μ‚¬ λ°μ΄ν„° μ΅°ν](#21-κ²€μ‚¬-λ°μ΄ν„°-μ΅°ν)
   - [μ΄λ ¥ λ°μ΄ν„° μ΅°ν](#22-μ΄λ ¥-λ°μ΄ν„°-μ΅°ν)
3. [λ°μ΄ν„° κ΄€λ¦¬ API](#λ°μ΄ν„°-κ΄€λ¦¬-apis)
   - [λ°μ΄ν„° μμ§‘ (Ingest)](#31-λ°μ΄ν„°-μμ§‘)
   - [λ°μ΄ν„° λ§νΈ κ°±μ‹ ](#32-λ°μ΄ν„°-λ§νΈ-κ°±μ‹ )
   - [μ¤λλ λ°μ΄ν„° μ •λ¦¬](#33-μ¤λλ-λ°μ΄ν„°-μ •λ¦¬)
4. [λ¶„μ„ API](#λ¶„μ„-apis)
   - [λ¶„μ„ μ”μ²­](#41-λ¶„μ„-μ”μ²­)
   - [λ¶„μ„ μƒνƒ ν™•μΈ](#42-λ¶„μ„-μƒνƒ-ν™•μΈ)
   - [λ¶„μ„ κ²°κ³Ό μ΅°ν](#43-λ¶„μ„-κ²°κ³Ό-μ΅°ν)
   - [μ¥λΉ„ λ­ν‚Ή μ΅°ν](#44-μ¥λΉ„-λ­ν‚Ή-μ΅°ν)

---

## 1. ν—¬μ¤ μ²΄ν¬

API μ„λ²„μ™€ λ°μ΄ν„°λ² μ΄μ¤μ μƒνƒλ¥Ό ν™•μΈν•©λ‹λ‹¤.

### μ—”λ“ν¬μΈνΈ
```
GET /health
GET /api/health
```

### μ”μ²­ μμ‹
```bash
curl http://localhost:8080/health
```

### μ‘λ‹µ (200 OK)
```json
{
  "status": "healthy",
  "stats": {
    "inspection": 1000000,
    "history": 500000,
    "glass_stats": 166666,
    "analysis_cache": 5,
    "analysis_jobs": 10
  }
}
```

---

## λ°μ΄ν„° μ΅°ν APIs

### 2.1 κ²€μ‚¬ λ°μ΄ν„° μ΅°ν

μ‹κ°„ λ²”μ„μ™€ μ„ νƒμ  ν•„ν„°μ΅°κ±΄μΌλ΅ κ²€μ‚¬(Inspection) λ°μ΄ν„°λ¥Ό μ΅°νν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
GET /api/inspection
```

#### νλΌλ―Έν„°

| νλΌλ―Έν„° | νƒ€μ… | ν•„μ μ—¬λ¶€ | μ„¤λ… |
|-----------|------|----------|-------------|
| start_time | string | **ν•„μ** | μ‹μ‘ μ‹κ°„ (ν•μ‹: `YYYY-MM-DD HH:MM:SS`) |
| end_time | string | **ν•„μ** | μΆ…λ£ μ‹κ°„ (ν•μ‹: `YYYY-MM-DD HH:MM:SS`) |
| process_code | string | μ„ νƒ | κ³µμ • μ½”λ“λ΅ ν•„ν„°λ§ (μ: `P100`) |
| defect_name | string | μ„ νƒ | λ¶λ‰λ…μΌλ΅ ν•„ν„°λ§ (μ: `SPOT-DARK`) |
| limit | integer | μ„ νƒ | μµλ€ λ°ν™ λ μ½”λ“ μ (κΈ°λ³Έκ°’: 1000) |
| offset | integer | μ„ νƒ | νμ΄μ§€λ„¤μ΄μ… μ¤ν”„μ…‹ (κΈ°λ³Έκ°’: 0) |

#### μ”μ²­ μμ‹

**κΈ°λ³Έ μ‹κ°„ λ²”μ„ μ΅°ν:**
```bash
curl "http://localhost:8080/api/inspection?start_time=2024-01-01%2000:00:00&end_time=2024-01-31%2023:59:59"
```

---

### 2.2 μ΄λ ¥ λ°μ΄ν„° μ΅°ν

Glass IDλ¥Ό κΈ°μ¤€μΌλ΅ κ³µμ • μ§„ν–‰ μ΄λ ¥μ„ μ΅°νν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
GET /api/history
```

#### νλΌλ―Έν„°

| νλΌλ―Έν„° | νƒ€μ… | ν•„μ μ—¬λ¶€ | μ„¤λ… |
|-----------|------|----------|-------------|
| glass_id | string | **ν•„μ** | μ΅°νν•  Glass ID (μ: `G00000001`) |
| process_code | string | μ„ νƒ | κ³µμ • μ½”λ“ ν•„ν„° |
| equipment_id | string | μ„ νƒ | μ¥λΉ„ ID ν•„ν„° |

#### μ”μ²­ μμ‹
```bash
curl "http://localhost:8080/api/history?glass_id=G00000001"
```

---

## λ°μ΄ν„° κ΄€λ¦¬ APIs

### 3.1 λ°μ΄ν„° μμ§‘ (Ingest)

μ†μ¤ μ‹μ¤ν…μΌλ΅λ¶€ν„° λ°μ΄ν„°λ¥Ό λ‹¤μ΄λ΅λ“ν•κ±°λ‚ Mock λ°μ΄ν„°λ¥Ό μƒμ„±ν•μ—¬ μμ§‘ν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
POST /api/ingest
```

#### μ”μ²­ λ°”λ””

| ν•„λ“ | νƒ€μ… | ν•„μ μ—¬λ¶€ | μ„¤λ… |
|-------|------|----------|-------------|
| start_time | string | **ν•„μ** | μ‹μ‘ μ‹κ°„ (RFC3339 ν•μ‹) |
| end_time | string | **ν•„μ** | μΆ…λ£ μ‹κ°„ (RFC3339 ν•μ‹) |

#### μ”μ²­ μμ‹
```bash
curl -X POST http://localhost:8080/api/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "start_time": "2024-01-01T00:00:00Z",
    "end_time": "2024-01-01T23:59:59Z"
  }'
```

---

### 3.2 λ°μ΄ν„° λ§νΈ κ°±μ‹ 

λ¶„μ„ μΏΌλ¦¬ μµμ ν™”λ¥Ό μ„ν•΄ `glass_stats` Materialized Viewλ¥Ό μ¬μƒμ„±ν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
POST /api/mart/refresh
```

#### μ”μ²­ μμ‹
```bash
curl -X POST http://localhost:8080/api/mart/refresh
```

---

### 3.3 μ¤λλ λ°μ΄ν„° μ •λ¦¬

μ„¤μ •λ λ³΄μ΅΄ κΈ°κ°„(Retention Period)λ³΄λ‹¤ μ¤λλ λ°μ΄ν„°λ¥Ό μ‚­μ ν•©λ‹λ‹¤ (κΈ°λ³Έκ°’: 1λ…„).

#### μ—”λ“ν¬μΈνΈ
```
POST /api/cleanup
```

---

## λ¶„μ„ APIs

### 4.1 λ¶„μ„ μ”μ²­

λΉ„λ™κΈ° λ¶„μ„ μ‘μ—…μ„ μ”μ²­ν•©λ‹λ‹¤ (Target vs Others λΉ„κµ).

#### μ—”λ“ν¬μΈνΈ
```
POST /api/analyze
```

#### μ”μ²­ λ°”λ””

| ν•„λ“ | νƒ€μ… | ν•„μ μ—¬λ¶€ | μ„¤λ… |
|-------|------|----------|-------------|
| defect_name | string | **ν•„μ** | λ¶„μ„ν•  λ¶λ‰λ… (μ: `SPOT-DARK`) |
| start_date | string | **ν•„μ** | μ‹μ‘ μΌμ (ν•μ‹: `YYYY-MM-DD`) |
| end_date | string | **ν•„μ** | μΆ…λ£ μΌμ (ν•μ‹: `YYYY-MM-DD`) |
| process_codes | array[string] | μ„ νƒ | κ³µμ • μ½”λ“ λ°°μ—΄ (μ: `["P100","P200"]`) |
| equipment_ids | array[string] | μ„ νƒ | Target κ·Έλ£ΉμΌλ΅ μ§€μ •ν•  μ¥λΉ„ ID λ°°μ—΄ |

#### μ”μ²­ μμ‹
```bash
curl -X POST http://localhost:8080/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "defect_name": "SPOT-DARK",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "process_codes": ["P100", "P200"],
    "equipment_ids": ["EQ001"]
  }'
```

#### μ‘λ‹µ (202 Accepted)
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending"
}
```

---

### 4.2 λ¶„μ„ μƒνƒ ν™•μΈ

λ¶„μ„ μ‘μ—…μ μ§„ν–‰ μƒνƒλ¥Ό ν™•μΈν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
GET /api/analyze/{jobId}/status
```

---

### 4.3 λ¶„μ„ κ²°κ³Ό μ΅°ν

μ™„λ£λ λ¶„μ„ μ‘μ—…μ κ²°κ³Όλ¥Ό μ΅°νν•©λ‹λ‹¤. (Glassλ³„, Lotλ³„, μΌλ³„, ννΈλ§µ λ°μ΄ν„° ν¬ν•¨)

#### μ—”λ“ν¬μΈνΈ
```
GET /api/analyze/{jobId}/results
```

---

### 4.4 μ¥λΉ„ λ­ν‚Ή μ΅°ν

λ¶λ‰λ¥  λΈνƒ€(μ „μ²΄ λ¶λ‰λ¥  - ν•΄λ‹Ή μ¥λΉ„ λ¶λ‰λ¥ )λ¥Ό κΈ°μ¤€μΌλ΅ μƒμ„ μ¥λΉ„λ¥Ό μ΅°νν•©λ‹λ‹¤. λΈνƒ€κ°€ λ†’μ„μλ΅(μ–‘μ) ν•΄λ‹Ή μ¥λΉ„μ μ„±λ¥μ΄ ν‰κ· λ³΄λ‹¤ μΆ‹μμ„ μλ―Έν•©λ‹λ‹¤.

#### μ—”λ“ν¬μΈνΈ
```
GET /api/equipment/rankings
```

#### νλΌλ―Έν„°

| νλΌλ―Έν„° | νƒ€μ… | ν•„μ μ—¬λ¶€ | μ„¤λ… |
|-----------|------|----------|-------------|
| start_date | string | **ν•„μ** | μ‹μ‘ μΌμ (`YYYY-MM-DD`) |
| end_date | string | **ν•„μ** | μΆ…λ£ μΌμ (`YYYY-MM-DD`) |
| defect_name | string | μ„ νƒ | λ¶λ‰λ… ν•„ν„° |
| limit | integer | μ„ νƒ | μµλ€ κ²°κ³Ό μ (κΈ°λ³Έκ°’: 100) |

#### μ”μ²­ μμ‹
```bash
curl "http://localhost:8080/api/equipment/rankings?start_date=2024-01-01&end_date=2024-12-31"
```

---

## μ—λ¬ μ‘λ‹µ

- **400 Bad Request**: ν•„μ νλΌλ―Έν„° λ„λ½ λλ” μλ»λ ν•μ‹.
- **404 Not Found**: μ”μ²­ν• Job IDλ¥Ό μ°Ύμ„ μ μ—†μ.
- **409 Conflict**: μ‘μ—…μ΄ μ•„μ§ μ™„λ£λμ§€ μ•μ.
- **500 Internal Server Error**: μ„λ²„ λ‚΄λ¶€ μ¤λ¥ (DB μ—°κ²° λ“±).
